# Data Persistence

Where each service stores its data, what survives upgrades, and what doesn't.

## Core Stack

All core data lives under `/opt/stoat/upstream/data/` as bind mounts defined in `upstream/compose.yml`.

| Service | Data path | Contents | Stateful? |
|---------|-----------|----------|-----------|
| **MongoDB** (database) | `upstream/data/db/` | User accounts, messages, channels, servers, all app data | Yes — primary datastore |
| **MinIO** | `upstream/data/minio/` | Uploaded files, avatars, emojis, attachments | Yes — all user uploads |
| **Caddy** | `upstream/data/caddy-data/` | TLS certificates (Let's Encrypt/ZeroSSL) and OCSP cache | Yes — losing this triggers new cert requests (rate limits apply) |
| **Caddy config** | `upstream/data/caddy-config/` | Caddy runtime config state | Ephemeral — regenerated on start |
| **RabbitMQ** | `upstream/data/rabbit/` | Internal message queue data | Semi-stateful — losing it means undelivered push notifications are dropped |
| **Redis** (KeyDB) | in-memory | Event broker, session cache | Ephemeral — no disk persistence, rebuilt on restart |
| **API, Events, Web, Autumn, January, Gifbox** | none | Stateless application containers | No — pulled fresh from images |

### Configuration files

| File | Path | Regenerated by |
|------|------|----------------|
| `Revolt.toml` | `upstream/Revolt.toml` | `stoatctl deploy core` (via upstream `generate_config.sh`) — only on first deploy |
| `.env.web` | `upstream/.env.web` | `stoatctl deploy core` (via upstream `generate_config.sh`) — only on first deploy |
| `Caddyfile` | `upstream/Caddyfile` | `rebuild_caddy.sh` — regenerated from `Caddyfile.base` + `Caddyfile.d/*.caddy` every deploy/update |

`Revolt.toml` and `.env.web` contain generated secrets (VAPID keys, etc.) and are **never overwritten** once they exist. Delete them manually to force regeneration.

## Addons

### Authentik SSO

| Data path | Contents | Stateful? |
|-----------|----------|-----------|
| `addons/authentik/data/` | Authentik application data | Yes |
| `addons/authentik/certs/` | Authentik TLS certificates | Yes |
| `addons/authentik/custom-templates/` | Email templates | Yes (if customized) |
| Postgres (Docker volume in addon compose) | Users, groups, providers, OAuth apps | Yes — primary Authentik datastore |
| Redis (Docker volume in addon compose) | Session cache | Ephemeral |
| `addons/authentik/.env` | Secrets (PG_PASS, AUTHENTIK_SECRET_KEY, SMTP) | Config — not overwritten by redeploy |

Redeploying with `stoatctl deploy authentik` preserves all data. The rsync excludes `.env`, `data/`, `certs/`, and `custom-templates/`.

### Admin Panel

| Data path | Contents | Stateful? |
|-----------|----------|-----------|
| `addons/admin-panel/.env.local` | OAuth credentials, DB connection strings, PLATFORM_ACCOUNT_ID | Config — not overwritten by redeploy |

The admin panel itself is **stateless**. It reads from the core MongoDB (`revolt` and `revolt_hr` databases) and authenticates via Authentik. No local database or files to persist.

Redeploying with `stoatctl deploy admin` rebuilds the Docker image and preserves `.env.local`.

### Maintenance Page

| Data path | Contents | Stateful? |
|-----------|----------|-----------|
| Caddy volumes (`caddy-data`, `caddy-config`) | TLS certificates for the maintenance domain | Semi-stateful — named Docker volumes persist across restarts |

The maintenance page is fully standalone with its own Caddy instance. TLS certs are stored in named Docker volumes (not bind mounts), so they persist across `stoatctl stop maintenance` / `stoatctl deploy maintenance` cycles but are lost on `docker volume prune`.

## What Survives Each Operation

| Operation | Core data | Addon data | TLS certs | Config files |
|-----------|-----------|------------|-----------|--------------|
| Manual update (`git pull` + `stoatctl deploy core`) | Preserved | Preserved | Preserved | Revolt.toml/.env.web preserved; Caddyfile regenerated |
| `stoatctl stop core` | Preserved | Preserved | Preserved | Preserved |
| `stoatctl deploy core` (redeploy) | Preserved | Preserved | Preserved | Revolt.toml/.env.web preserved (skip if exists); Caddyfile regenerated |
| `stoatctl deploy authentik` (redeploy) | N/A | Preserved (.env, data/, certs/) | N/A | .env preserved |
| `stoatctl deploy admin` (redeploy) | N/A | N/A (stateless) | N/A | .env.local preserved |
| `stoatctl destroy core` | **DELETED** | **DELETED** (everything under /opt/stoat) | **DELETED** | **DELETED** |
| `stoatctl restore` | Replaced from backup | Not affected | Not affected | Replaced from backup |

## HR Database (Admin Panel RBAC)

The admin panel's role-based access control lives in the `revolt_hr` MongoDB database (inside the core MongoDB instance). This is seeded by `bootstrap.sh` (called automatically by `stoatctl deploy core`) using the `admin@BASE_DOMAIN` address (override with `BOOTSTRAP_ADMIN_EMAIL`).

| Collection | Contents |
|------------|----------|
| `revolt_hr.roles` | Role definitions (e.g., "Administrator" with `["*"]` permissions) |
| `revolt_hr.people` | Person records linking email to roles |
| `revolt_hr.positions` | Position definitions (unused in current setup) |

The person record's `email` field must match the user's Authentik login email for SSO to authorize them in the admin panel.

To manually inspect or update HR records:

```bash
# View all HR records
docker compose -f /opt/stoat/upstream/compose.yml \
  -f /opt/stoat/overrides/docker-compose.override.yml \
  exec -T database mongosh revolt_hr --quiet --eval '
    print("=== roles ==="); db.roles.find().pretty();
    print("=== people ==="); db.people.find().pretty();
  '

# Update a person's email
docker compose -f /opt/stoat/upstream/compose.yml \
  -f /opt/stoat/overrides/docker-compose.override.yml \
  exec -T database mongosh revolt_hr --quiet --eval '
    db.people.updateOne(
      { _id: "01ADMIN_PERSON" },
      { $set: { email: "new-email@example.com" } }
    )
  '
```

## Backup Coverage

`stoatctl backup` captures:
- MongoDB (all databases including `revolt` and `revolt_hr`) via `mongodump`
- MinIO data (`upstream/data/minio/`)
- Config files (`Revolt.toml`, `.env.web`, `Caddyfile`)

**Not backed up** by the script (handle separately or via VPS snapshots):
- Authentik Postgres database and data directory
- Authentik `.env` and admin panel `.env.local`
- TLS certificates (`upstream/data/caddy-data/`)
- Addon Docker volumes
