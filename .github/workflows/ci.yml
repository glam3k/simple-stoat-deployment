name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Prepare env
        run: cp .env.example .env
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Shellcheck scripts
        run: |
          set -euo pipefail
          files=$(find bin -maxdepth 1 -name '*.sh')
          if [[ -n "$files" ]]; then
            shellcheck $files
          fi
      - name: Compile stoatctl
        run: python -m compileall bin/stoatctl

  e2e-core:
    runs-on: ubuntu-latest
    needs: lint
    env:
      STOAT_DIR: ${{ github.workspace }}/.ci/stoat
      COMPOSE_HTTP_TIMEOUT: '180'
      CADDY_USE_INTERNAL_CA: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up env file
        run: |
          cat <<'ENV' > .env
          BASE_DOMAIN=ci.local
          STOAT_SUBDOMAIN=chat
          AUTH_SUBDOMAIN=sso
          ADMIN_SUBDOMAIN=admin
          ENV
      - name: Configure Authentik env
        run: |
          cat <<'ENV' > addons/authentik/.env
          PG_USER=authentik
          PG_PASS=authentikpassword
          PG_DB=authentik
          AUTHENTIK_SECRET_KEY=devsecretkey1234567890devsecretkey
          AUTHENTIK_EMAIL__FROM="Stoat CI" <noreply@example.com>
          AUTHENTIK_EMAIL__HOST=localhost
          AUTHENTIK_EMAIL__PORT=25
          AUTHENTIK_EMAIL__USE_TLS=false
          AUTHENTIK_EMAIL__USE_SSL=false
          AUTHENTIK_EMAIL__USERNAME=
          AUTHENTIK_EMAIL__PASSWORD=
          ENV
      - name: Customize Authentik fixture
        run: |
          BASE_DOMAIN=ci.local
          AUTH_HOST=sso.ci.local
          ADMIN_EMAIL=admin@ci.local
          sed \
            -e "s/testdomain\\.testtdn/${BASE_DOMAIN}/g" \
            -e "s/email@testdomain\\.testtdn/${ADMIN_EMAIL}/g" \
            -e "s|https://testdomain\\.testtdn|https://${AUTH_HOST}|g" \
            "$GITHUB_WORKSPACE/fixtures/authentik-data.sql" \
            > "$GITHUB_WORKSPACE/fixtures/authentik-data-ci.sql"
      - name: Map CI hostnames to localhost
        run: |
          echo "127.0.0.1 chat.ci.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 sso.ci.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 admin.ci.local" | sudo tee -a /etc/hosts
      - name: Deploy core stack
        run: |
          mkdir -p "$STOAT_DIR"
          STOAT_DIR="$STOAT_DIR" bin/stoatctl deploy core
      - name: Deploy Authentik
        run: |
          STOAT_DIR="$STOAT_DIR" bin/stoatctl deploy authentik
      - name: Seed Authentik database
        run: |
          set -euo pipefail
          AUTH_DIR="$STOAT_DIR/addons/authentik"
          cd "$AUTH_DIR"
          docker compose stop server worker
          docker compose exec -T postgresql \
            psql --username "${PG_USER:-authentik}" --dbname "${PG_DB:-authentik}" \
            < "$GITHUB_WORKSPACE/fixtures/authentik-data-ci.sql"
          docker compose up -d server worker
      - name: Check Authentik readiness
        run: |
          curl --retry 15 --retry-all-errors --retry-delay 5 --fail http://sso.ci.local:9000/health/ready/
      - name: Destroy Authentik stack
        if: always()
        run: |
          STOAT_DIR="$STOAT_DIR" bin/stoatctl destroy authentik || true
      - name: Destroy core stack
        if: always()
        run: |
          printf 'DESTROY\n' | STOAT_DIR="$STOAT_DIR" bin/stoatctl destroy core || true
          j
